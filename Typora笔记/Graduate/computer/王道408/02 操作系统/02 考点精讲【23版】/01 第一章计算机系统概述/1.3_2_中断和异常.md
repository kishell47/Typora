# 中断和异常



## 知识总览

<img src="https://cvp.oss-cn-shanghai.aliyuncs.com/picgo/202305071357789.png" alt="image-20230507135731708" style="zoom:50%;" />

* 学习中断和异常相关的知识点
* 首先会介绍中断的作用，这其实在上一小节当中也有提到过。 只不过由于这个内容十分重要，所以还是愿意做一个复读机
* 另外会介绍一下中断有哪些类型，大致上可以分为内中断和外中断两种，内中断又可以称为异常，最后我们会简单的介绍一下中断这种机制实现的具体的原理



## 中断的作用

* <img src="https://cvp.oss-cn-shanghai.aliyuncs.com/picgo/202305081449851.png" alt="image-20230508144906725" style="zoom: 67%;" />

* 首先看一下中断的作用，在上一小节中，已经学习到了CPU上面其实会运行两种类型的程序，一种是操作系统的内核程序。 一种是普通的应用程序，而内核程序是整个系统的管理者。 计算机在刚启动的时候，其实在上边跑的肯定是内核程序，只不过在时机合适的时候，内核程序会把CPU的使用权主动的让给应用程序，这个部分是第二章进程管理当中会具体学习的内容，这儿暂且先不展开。 
* 总之，一个应用程序在上CPU运行之后，就会一直运行下去，除非发生了中断，而一旦发生中断，就会让CPU立即停止此时正在执行的应用程序，转而执行相应的内核程序，所以中断是让管理者也就是操作系统内核重新夺回CPU使用权的唯一的途径。而中断会使CPU由用户态变为内核态。可以思考一下，假如说没有中断机制的话，那么一旦一个应用程序上CPU运行了，那么这个应用程序就可以一直运行下去。 如果一个CPU一直在运行同一个应用程序的话，又怎么可能实现多道程序并发这个事情呢？所以没有中断技术肯定就没办法实现多道程序并发，甚至可以说没有中断技术就没有操作系统。
* 总之，操作系统内核是一个管理者，当他想要把CPU使用权让给应用程序的时候，那么他会自愿的用一个特权指令完成这个事情。 但是当他想要把CPU的使用权重新给夺回来的时候，那么他也可以通过中断的这种方式来实现。



## 中断的类型

* <img src="https://cvp.oss-cn-shanghai.aliyuncs.com/picgo/202305081500224.png" alt="image-20230508150016133" style="zoom:50%;" />
* 接下来看的是中断有哪种类型：
  *  一种叫内中断
  * 一种叫外中断
* 内中断的产生和当前执行的指令是有关系的，中断信号来源于CPU内部
* 外中断和当前执行的指令无关，中断信号来源于CPU的外部



## 内中断的例子

* <img src="https://cvp.oss-cn-shanghai.aliyuncs.com/picgo/202305081510177.png" alt="image-20230508151006044" style="zoom: 67%;" />
* 首先来看几个内中断的例子。 
* 内中断也就是说这种中断的产生和当前执行的指令有关。就比如说上一小节当中提到的例子一个应用程序运行在用户态，然后CPU会依次处理它的这些指令。 但是假如说有一个猥琐的黑客在这个应用程序当中尝试植入一条特权指令的话，那么当CPU拿到这条特权指令的时候，他发现此时正在处于用户态，此时在运行的是应用程序，于是这个非法的事件会触发一个中断信号，CPU会拒绝执行这一条特权指令。 接下来CPU会自动的转变为内核态，并且会开始执行处理这个中断信号相关的内核程序。 
* 于是在发生了这样非法的事情之后，这个系统的管理者又重新夺回了CPU的控制权。 所以这就是一个很典型的内中断的例子。CPU在执行当前的一条指令的时候，由这条指令引发了一个中断。 有的时候即使CPU执行的是非特权指令， 也有可能会引发内中断，比如说CPU在执行一个除法指令的时候，它发现除数是零。那在这种情况下，肯定也不能让这个程序继续执行下去，所以这种情况也会引发一个内中断。 总之，如果当前执行的这个指令本身是非法的， 或者说指令的一些参数是非法的，那么这种情况下就会产生一个内中断的信号。 
* <img src="https://cvp.oss-cn-shanghai.aliyuncs.com/picgo/202305081511753.png" alt="image-20230508151125665" style="zoom: 67%;" />
* 接下来再来看另一个内中断的例子
* 一个应用程序运行在用户态，但是有的时候应用程序它是想要请求操作系统内核为它提供一些服务的，在这种情况下，应用程序就会执行一条特殊的指令叫做陷入指令，这个指令会引发一个内部中断信号，接下来CPU又会转向这个中断信号相应的处理程序进行这个中断信号的处理。 所以可以看到，当一个应用程序执行了陷入指令的时候， 就意味着这个应用程序主动的把CPU使用权还给操作系统内核，想让操作系统内核为它提供某些服务，之前提到的系统调用其实就是用陷入指令来完成的。
* 需要强调的一点是陷入指令是一个比较特殊的指令，但是它并不是特权指令。 因为我们可以想一下这个应用程序，它是运行在用户态的，在用户态下可以执行这个陷入指令的话，那这个陷入指令肯定也不是特权指令了。
* 总之，刚才提到的这个中断信号，其实也和当前执行的这条指令是有关系的。 这个中断信号是来自于CPU的内部。 



## 外中断的例子

* <img src="https://cvp.oss-cn-shanghai.aliyuncs.com/picgo/202305081518481.png" alt="image-20230508151818313" style="zoom: 67%;" />
* 接下来看几个外中断的例子，外中断和当前执行的指令无关，这个中断信号来自于CPU的外部。
* 来看第一个例子叫做时钟中断，这种中断信号是由计算机当中的一个硬件， 叫做时钟部件来发出的。 这个时间部件会每隔一段时间给CPU发一个中断信号，通过这个时钟中断信号就可以实现多道程序并发运行了。来看一下这个故事是怎么样的？
* 假设此时系统当中想要并发的运行两个应用程序，首先应用程序1运行在用户态，然后CPU会执行它的这些指令，然后当它执行了两条应用程序1的指令的时候。 这个时钟部件发现此时已经过了50毫秒了，那么它会给CPU发送一个中断信号，注意这个中断信号和当前执行的指令是没有关系的，它来自于CPU的外部。 根据之前学习到的知识，知道当CPU检测到一个中断信号的时候，它会先暂停此时正在运行的应用程序，然后转而执行一个相应的内核程序来处理这个中断信号，所以接下来CPU会对这个时钟中断信号进行处理，并且转为内核态，在内核态下CPU开始执行这个内核程序来处理刚才收到的中断信号。这个内核程序执行的过程当中发现应用程序1刚才已经用了50毫秒的时间了，所以接下来为了公平起见，想让第二个应用程序上CPU运行。 于是接下来这个内核程序会把CPU的使用权给第二个应用程序，接下来又切换回用户态，然后第二个应用程序开始上CPU运行，而当第二个应用程序执行了一系列的指令之后，又过了50毫秒。 此时这个时钟部件又会给CPU发送一个来自于外部的中断信号，同样的CPU还是会回去执行和这个中断信号相关的那个处理程序，所以接下来它又会开始执行这个内核程序，接下来这个操作系统内核发现程序2已经用了50毫秒了。 所以接下来公平起见，我又想让程序1上去接着运行。 于是他会把CPU的使用权让给应用程序1。 然后应用程序1就可以接着往下执行它之后的那一系列的指令了，所以刚才的这个故事中就很清晰的看到了两个应用程序是如何在中断机制的支持下实现并发运行的往下执行它之后的那一系列的指令了
* 所以从刚才的这个故事中就很清晰的看到了两个应用程序是如何在中断机制的支持下实现并发运行的一直不断的相互切换，所以可以看到， 中断在现代的计算机中到底有多大的作用。
* 除了这个时钟部件发出的中断信号之外，有时候还会有来自于IO设备，也就是input output也就是输入输出设备发来的中断信号。
* 比如说某一个应用程序，可能会请求打印机的打印服务，打印机在打印输出完成了之后，会向CPU发送中断信号，用来通知CPU我的任务已经完成了。 接下来CPU会用这个中断信号相对应的内核程序来对这个中断信号进行处理。
* 总之，我们这儿提到的这两种中断，中断的信号都来自于CPU的外部和当前执行的指令是没有关系的。CPU在每一个指令执行结束的时候都会例行的检查一下是否有外部中断的信号需要我来处理。
* 通过列举的一些内中断和外中断的例子，可以更直观的感受到中断这种机制强大的作用。



## 中断的分类

* <img src="https://cvp.oss-cn-shanghai.aliyuncs.com/picgo/202305081544682.png" alt="image-20230508154401536" style="zoom: 67%;" />
* 要分辨一个中断是内中断还是外中断， 只需要判断这个中断信号的产生和当前执行的指令是否有关就可以了。 
* 刚才我们讲解的过程中使用的是内中断和外中断这两个术语，因为内外这两个形容词可以让大家很形象地理解到它们俩之间的一个本质的区别，不过在很多教材，还有很多学校的考试当中内中断 一般会称为异常，外中断一般就直接称为中断。 所以考试当中遇到的中断一般来说是这个狭义的中断，特指外中断，而我们这个小节当中，之前一直在说的中断，其实指的是这种广义的中断。所以大家要理解它们的区别，可以用内外这两种方式来理解，但是在做题的过程当中，更需要注意的是中断和异常这两个术语。 在接下来的讲解中，会经常使用到异常这个术语，大家需要知道它其实指的就是内中断。 
* 异常又可以进一步的划分为这样的三种
  * 第一种叫做陷入trap，这个其实就是刚才所提到的由陷入指令引发的那种异常， 这种异常是程序故意引发的。 当一个程序想要请求操作系统的服务的时候，它就会故意的执行这一条指令，这也是系统调用实现的原理，而系统调用的内容会在下一小节再继续展开
  * 第二种异常称为故障，故障是一种由错误条件引起的，并且可能被内核程序修复的问题。 内核程序修复故障之后，会把CPU的使用权还给应用程序，让它继续执行下去。 比如说在第三章当中会学习到的缺页故障。这个地方暂时理解不了，没有关系，等学完了第三章再回来细细品味
  * 第三种异常叫做终止。 终止是由致命的错误引起的，这种错误一般是内核程序无法修复的，所以一般来说当发生了这种类型的异常之后，内核程序就不会再把CPU的使用权还给引发终止的那个应用程序，一般来说会直接的把这个应用程序给干掉，让它终止掉。 比如说刚才提到的两个例子，整数除以零这种错误，就是程序bug也不是操作系统能够修复的，是程序本身的问题。或者非法的使用特权指令，这样的程序也应该直接把它干掉，不应该再把CPU的使用权再还给它。所以这是第三种终止。 
  * 异常或者说内中断的这三种分类方式，大家需要注意一下，曾经考过。 



## 中断机制的基本原理

* <img src="https://cvp.oss-cn-shanghai.aliyuncs.com/picgo/202305081557514.png" alt="image-20230508155752395" style="zoom: 67%;" />
* 接下来简单地介绍一下中断机制背后的基本原理。 刚才举了各种各样的中断的例子，有的中断是整数除以零，有的中断是时钟部件引起的，而有的中断又是应用程序自己引发的。很显然，这么多的中断类型不可能用同一个程序来处理，所以CPU会根据中断信号的不同来找到和这个中断信号相对应的中断处理程序，具体的做法是CPU在检测到中断信号之后，会根据这个中断信号的类型来查询中断向量表。然后通过这个中断向量表找到各种类型的中断所对应的中断处理程序。 很显然，之前讲了那么多例子，大家应该也能够想到中断处理程序其实就是一种内核程序，肯定是需要运行在内核态的。这就是中断机制的基本实现原理， 但是具体硬件上应该怎么实现这是计算机组成原理那门课要教大家的。 如果不考那门课的同学，其实理解到这儿就差不多了



## 知识回顾与重点考点

<img src="https://cvp.oss-cn-shanghai.aliyuncs.com/picgo/202305081621028.png" alt="image-20230508162143872" style="zoom: 67%;" />

* 这个小节当中介绍了中断和异常。中断的作用十分重要，它是让CPU从用户态变回内核态的唯一方式。是让操作系统强行夺回CPU控制权的一种方式，在引入了中断机制之后，才能让操作系统正常工作。才能实现多道程序并发运行这个美好的事情
* 中断的分类这个知识点，大家可以在根据课后的习题进行巩固。
* 最后，简要地提了一下中断机制的基本实现原理。总之，分为这样的两个步骤，CPU首先会检查中断信号。对于内中断信号来说，是CPU在执行指令的时候就会进行检查的，它会检查是否有异常的发生。而外中断信号的检查是在每个指令周期的末尾，也就是CPU每执行完一条指令之后，它都会例行的来检查是否有外部中断信号需要处理。当CPU检测到一个中断信号之后，又会根据这个中断信号来查询中断向量表，然后找到这个类型的中断信号所对应的中断处理程序来进行处理。

