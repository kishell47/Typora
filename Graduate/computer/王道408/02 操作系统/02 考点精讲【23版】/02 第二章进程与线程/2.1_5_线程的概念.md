# 线程概念多线程模型



## 知识总览

<img src="https://cvp.oss-cn-shanghai.aliyuncs.com/picgo/202305142152955.png" alt="image-20230514215232875" style="zoom:67%;" />

* 在这个小节中会学习线程相关的一系列的知识点，首先会用一个例子来介绍什么是线程，为什么要引入线程机制？在引入线程机制之后，比起传统的进程机制来说，带来了哪些变化？之后会介绍线程有哪些重要的
  属性？ 
* 首先来看一下什么是线程，为什么要引入线程呢？ 

<img src="https://cvp.oss-cn-shanghai.aliyuncs.com/picgo/202305142154180.png" alt="image-20230514215442100" style="zoom: 67%;" />

* 在很久很久以前在没有引入进程之前，系统之间的各个程序是只能串行执行的。 所以在那个时候，比如说想一边运行音乐播放程序，一边运行QQ程序，那么显然是不可以实现的。 在那个时候，我们不可能边聊QQ，边听音乐，但之后引入了进程的机制，之后就可以实现边聊QQ边听音乐这样的事情。 但是大家再来深入的思考一下QQ可以做一些什么事情呢？可以用QQ进行视频聊天，同时还可以和其他的人进行文字聊天。再同时还在传送文件，那么这些事情是怎么在进程当中完成的呢？ 很显然，在传统的进程定义当中，进程是程序的一次执行，但是这些功能视频聊天，文字聊天，传送文件，这些功能显然是不可能由一个程序顺序执行来处理的。 如果只能顺序的来处理，那么就不可能在用户看来，这几件事情是可以同时发生的，就不可能有这样的现象

<img src="https://cvp.oss-cn-shanghai.aliyuncs.com/picgo/202305142159536.png" alt="image-20230514215915447" style="zoom: 67%;" />

* 所以有的进程其实它是需要同时处理很多事情的， 就像刚刚才说的QQ那样。 但是传统的进程， 只能串行的执行一系列的程序代码。 就是这个样子，在传统的进程机制当中CPU会轮流的为各个进程进行服务。 那么这些进程就可以并发的执行，并且每一个进程会有它自己相应的一系列程序代码，然后被CPU服务的时候，这些代码就可以一句一句开始往下执行，所以在传统的进程机制当中，进程是执行流的最小单位。这句话什么意思呢？听了后面的讲解大家应该就可以理解，之后为了满足像咱刚才说的一个进程当中，宏观上同时做很多事情，人们又引入了线程机制，用来增加系统的并发度。引入了线程之后。 CPU的调度服务对象就不再是进程，而是进程当中的线程。 每一个进程当中可能会包含多个线程，然后CPU会轮流的被用一定的算法轮流地为这些线程进行服务。就像这个样子。为各个线程服务，这样的话，同一个进程当中被分为了多个线程，像刚才说的QQ视频聊天和传送文件这两件事情，如果想要并发的执行的话，那么我们就可以把这两件事情对应的处理程序放到两个不同的线程下。那么，这两个线程可以并发的执行，自然这两件事就可以并发的完成，所以在引入了线程机制之后。线程就成了程序执行流的最小单位。 在没有引入线程之前，一个进程其实就对应一份代码，这些代码只能顺序的依次往下执行，但是在引入了
  线程之后，每一个进程可以有多个线程，并且这些线程可以有各自不同的代码，也可以是不同的线程，运行的是同一份代码。 但是这些代码都会并发的被CPU处理，然后并发的依次执行下去，所以这就是程序执行流的最小单位的意思

* <img src="https://cvp.oss-cn-shanghai.aliyuncs.com/picgo/202305142207006.png" alt="image-20230514220747924" style="zoom:67%;" />

* 线程其实可以把它理解为是一种轻量级的进程。 以前CPU调度的单位是进程， 但是现在CPU的服务对象不是进程，而是以线程为单位，所以线程是基本的CPU执行单元，也是程序执行流的最小单位，这个经过刚才的讲解，相信大家已经可以理解。 在引入了线程之后，进程之间可以并发的执行，并且进
  程之间的各个线程也可以并发的执行，所以引入了线程机制进一步的提高了系统的并发度。 可以使得一个进程内也可以并发的处理各种各样的任务，就像刚才聊到的qq聊天，传文件这些事情。然后在引入了线程之后，进程不再是CPU调度的基本单位，进程只作为除了CPU之外的系统资源的分配单元。什
  么意思呢？ 假如这个计算机系统当中有各种各样的系统资源，那么这些资源是被分配给进程的而不是分配给线程。 就像这个样子

* 那么在引入了线程机制之后，比起传统的进
  程机制来说，有了哪些变化呢？

  <img src="https://cvp.oss-cn-shanghai.aliyuncs.com/picgo/202305142211925.png" alt="image-20230514221110801" style="zoom: 67%;" />

* 首先看一下资源分配和处理机调度方向，这个刚才已经讲过传统的进程机制当中，进程既是资源分配的基本单位，也是处理机调度的基本单位。 但是，在引入线程之后，进程只是资源分配的基本单位，而线程变成了调度的基本单位，这是区别。

* 在并发性角度来讲，传统的进程机制中，进只能是进程之间并发的执行。但是，在引入了线程之后，各个线程间也可以并发执行，所以进一步提升了系统的并发度。 

* 在实现并发带来的系统开销方面，传统的进程间并发需要切换进程的运行环境， 切换进进程的运行环境，其实系统开销是比较大的，但是引入了线程机制之后，如果我们是切换同一个进程内的不同线程。 那么，我们不需要切换进程的运行环境，这样的话，并发所带来的系统开销就会进一步的降低。 怎么理解切换进程的运行环境所带来的系统开销呢？我们来用一个去图书馆看书的例子来来理解。 假如说你在使用图书馆当中的某一张桌子， 但是突然有一个你不认识的人也要用这个桌子，那么你需要把你的运行环境，你的书给收走，然后他要把自己的运行环境把他自己的书放到桌子上，所以这就是进程切换所带来的运行环境的切换。 这个切换过程其实需要付出一定代价的，你需要把书搬走， 它需要把书放上去，但是如果说，这个时候是你的舍友想要用这张书桌的话，那么既然你们认识，就相当于你们俩是属于同一个进程的这种情况下就可以不把你自己的书收走，把书依然放在桌子上，这就类似于同一进程内的线程的切换。 同一进程内的线程切换不需要切换进程的运行环境，所以由于
  你们不需要把书挪来挪去， 因此这个开销也会降低很多。

* 接下来再来看一下线程有哪些属性

  <img src="https://cvp.oss-cn-shanghai.aliyuncs.com/picgo/202305142217074.png" alt="image-20230514221714966" style="zoom: 67%;" />

* 线程是处理机调度的单位，这个刚才已经强调
  过很多次了，然后多CPU计算机当中就是多核CPU的计算机当中每个线程可以占用不同的CPU，比如说现在的CPU一般都是双核， 四核，八核的，各个线程可以分配到不同的核心里去。 

* 另外每一个线程，会有一个线程ID和线程控制块TCB这样的数据结构，线程控制块其实有点类似于之前学过的PCB进程控制块，线程控制块也是用于管理线程所创建的一个数据结构。 那么和进程类似线程也会有就绪，阻塞运行这样的三种基本状态。 因为引入了线程机制之后，线程它只是处理机调度的基本单位，而系统资源分配是分配给进程的，所以线程几乎不拥有系统资源。 系统资源都是在进程那里，那么线程肯定也需要使用一系列的系统资源，这些系统资源从哪里来呢？其实同一个进程当中的不同线程是可以共享使用这个进程所拥有的系统资源的，这些系统资源包括像IO设备有内存地址空间这样的资源。 由于同一个进程当中的不同线程，它们可以共享内存地址空间，所以同一个进程中的线程它们之间的通信就可以不需要操作系统干预可以直接通过共享的内存地址空间就可以完成它们之间的信息传递

* 另外还需要注意同一个进程中的线程切换，其实并不会引起进程切换，但是不同的进程中的线程切换会引起进程切换，如果我们切换的是同进程内的线程，那么由于不需要切换进程的运行环境，所以系统开销是比较小的。 如果我们切换的是不同进程间的线程，那么它会导致进程的切换， 相应的也需要切换进程的运行环境，所以系统开销就比较大。 这个就是刚才讲到的图书馆那个例子

* 这就是线程的相应的一系列属性。