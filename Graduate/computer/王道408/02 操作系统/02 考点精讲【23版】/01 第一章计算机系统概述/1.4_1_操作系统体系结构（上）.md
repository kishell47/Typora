# 操作系统的体系结构（上）



## 知识总览

<img src="https://cvp.oss-cn-shanghai.aliyuncs.com/picgo/202305101007407.png" alt="image-20230510100742333" style="zoom:50%;" />

* 在这个小节中，会学习操作系统的体系结构，也就是操作系统的内核应该怎么设计的问题。
* 这个小节的内容，只需要做简要的了解就可以了，考试中常考的是这样的两种体系结构，一种叫大内核，一种叫微内核。 



## 操作系统的内核

<img src="https://cvp.oss-cn-shanghai.aliyuncs.com/picgo/202305101014318.png" alt="image-20230510101429240" style="zoom: 50%;" />

* 经过之前的学习知道计算机系统的层次结构是这个样子的，但是操作系统的内部其实还可以再进行进一步的划分。 一部分是内核的功能，另一部分是非内核的功能。
* 操作系统最核心的功能需要放在操作系统的内核当中。 比如说时钟管理、中断处理，还有原语，另外还有之后要学习的进程管理，存储器管理，设备管理等等。这些功能都是要放在操作系统内核当中的。 这提到的时钟管理其实就是之前提到过的时钟中断来实现了计算机计时的功能。 想要实现程序并发，就必然离不开时钟管理这个很重要的内核功能
* 中断处理就不再多解释了，之前已经举了很多例子。 另外还有一种特殊的程序，叫做原语，原语这种程序具有原子性，所谓的原子性就是说这种程序要么就一气呵成的全部运行完成要么就是不运行，它的执行过程是不可被中断的，也就是说，在执行原语这一小段程序的过程当中，即使有外部中断信号过来了，CPU也会继续把原语执行完成才去处理外部中断信号，总之这列举的最下面这一层的这三个东西是和硬件结合最为紧密的。所以它们必须放在操作系统的内核当中。 其实像Ubuntu、还有CentOS等等这些我们耳熟能详的Linux操作系统的开发团队，他们主要干的事情其实是在实现非内核的功能。 而这些操作系统的内核使用的就是Linux的内核



## 操作系统的内核

* <img src="https://cvp.oss-cn-shanghai.aliyuncs.com/picgo/202305101027845.png" alt="image-20230510102748603" style="zoom: 67%;" />
* 总之，内核是操作系统最核心，最基本的部分，它由一系列的内核程序组成，这些内核程序必须运行在内核态，
* 刚才提到的最底层的这三个部分（时钟管理、中断处理、原语）是与硬件关联最紧密的模块，这些功能是必须放在内核当中的。
* 还有一些管理相关的功能，像进程管理，存储器管理，对于这些功能的管理，更多的是对数据结构的操作，而不会直接涉及到硬件。 所以有的操作系统并不把这些管理功能放在内核当中，而只在内核当中保留与硬件接触最紧密的这些部分。 



## 操作系统的内核

<img src="https://cvp.oss-cn-shanghai.aliyuncs.com/picgo/202305101033167.png" alt="image-20230510103333019" style="zoom:50%;" />

* 因此，这就引出了两种截然不同的内核的设计方法，把所有的功能都包含在操作系统内核当中的这种结构就叫做大内核。 
* 而如果内核当中只保留与硬件关系最紧密的这些部分，那么这种内核就叫做微内核，需要注意的是如果采用的是微内核的这种结构的话，那么属于内核的这些功能是需要运行在内核态的，而不属于内核的上面的这些功能就需要运行在用户态。
* 这会对我们系统的性能造成一定的影响，用更直观的例子来体会这一点。 



## 操作系统的体系结构

<img src="https://cvp.oss-cn-shanghai.aliyuncs.com/picgo/202305101038743.png" alt="image-20230510103810602" style="zoom:50%;" />

* 假设现在有两种体系结构的系统，第一个系统采用的是大内核的体系结构，那么由于进程管理，存储管理等等这一些功能都是被划分在内核当中的。所以这些功能的处理都需要运行在内核态，而只有应用程序是运行在用户态的
* 而对于采用微内核结构的操作系统来说。 只有和硬件联系最紧密的这些功能被划分在了内核当中，只有这些功能是需要在内核态下才可以执行的，而其他的功能模块在用户态下就可以运行。 
* 现在来看这样一个故事，假设现在这个应用程序想要请求操作系统的服务，并且这个服务的背后需要同时涉及到进程管理，存储管理，设备管理这几个功能，如果采用的是大内核的体系结构的话，那么应用程序向操作系统提出服务的请求，这个时候CPU会从用户态切换为核心态。然后开始运行这一系列的内核程序，而如果采用的是微内核的体系结构的话，应用程序向操作系统提出服务的请求。接下来操作系统这几个模块都需要为应用程序服务，而进程管理这个模块在处理应用程序的请求的时候，它同样也需要得到内核的支持。所以这个模块对内核的访问就涉及到了CPU从用户态转到内核态，服务完成了之后又会从内核态再转回用户态。然后同样地存储管理和设备管理这两个模块他们也在完成相应的工作的时候，同样也需要得到内核的支持，因此每一个模块都需要请求内核的服务，每一次请求内核的服务都会涉及到一个CPU状态转换的过程，因此如果我们采用的是大内核的体系结构的话，那么应用程序的这个请求只需要两次变态就可以了。这儿一次，这儿一次，而如果采用的是微内核的体系结构的话，那么整个过程的处理就需要有六次变态。需要注意的是，这个CPU的状态转换这个过程其实是有成本的，需要消耗不少的时间，因此频繁的切换CPU的状态是会降低系统性能的。
* 这个地方需要强调一下，大家在考试的时候不要使用变态这个词，这个只是我们为了方便描述，然后使用的一种描述方式，在考试答题的时候需要写的正规一点，就是要说成是CPU状态的转换。



## 知识回顾与重要考点

<img src="https://cvp.oss-cn-shanghai.aliyuncs.com/picgo/202305101109872.png" alt="image-20230510110950652" style="zoom:50%;" />

* 这个小节介绍的是操作系统的体系结构，分为大内核和微内核，通过刚才的例子，相信大家也能够体会它们俩的区别。 
* 大内核的优点就是性能高，因为应用程序在请求内核服务的时候变态的过程会比较少
* 而微内核的缺点是需要频繁的在核心态和用户态之间切换。 所以它的性能会更低一些，不过微内核的优点是它的内核功能很少，所以结构清晰，方便程序员维护，而大内核由于他们把很多很多功能都放在内核里。 所以内核代码就会变得比较庞大，结构混乱难以维护。 
* 典型的大内核操作系统像Linux、Unix这些都是大内核的,然后微内核的操作系统的话，大家可以去看一下Windows NT。 当然，这些并不是考试考察的重点，考试的时候只会考察这两种体系结构的优缺点，大家只要能够有个印象就可以。