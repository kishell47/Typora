# 虚拟机



## 传统计算机

<img src="https://cvp.oss-cn-shanghai.aliyuncs.com/picgo/202305102054107.png" alt="image-20230510205421039" style="zoom:50%;" />

* 这个小节中介绍虚拟机的概念，首先看一下传统的计算机，传统的计算机在一个物理机器上只能运行一个操作系统，操作系统之上又可以运行各种各样的用户进程，这看起来似乎是很合理的，但是在有的商业化的环境当中，这会导致硬件资源利用率不充分的问题，比如你拥有一个非常强大的一个物理机，性能很好，但是由于这台机器上只能运行一个操作系统。 那么你的这台机器，如果想要租给其他人使用的话，那其他人的要运行的东西只能在同一个操作系统之上运行。 比如说王者荣耀的游戏服务器和吃鸡的游戏服务器，必须放在同一个操作系统之上来运行，但两个进程在同一个操作系统之上有可能会有一些安全隐患，他们之间可能会相互影响，也会相互的争夺操作系统管理的资源。 所以在商业环境当中两个应用让他们同时在一个操作系统上运行可能会造成一些隐患。 一种解决方法是把其中一个应用迁移到另一台物理机器上然后这台物理机器上有一个独立的操作系统，这样两个应用就不可能相互影响，但是这又会导致物理机器硬件资源的极大浪费。刚才我们说很多商业级的物理机器的性能是很强的。 硬件性能本来可以同时支持两个进程的使用绰绰有余，但是为了安全起见，又不得不浪费，把其中一个进程迁移到另一台机器上去运行。
* 所以传统的这种结构，一个机器上只能安装一个操作系统会带来很多应用上的限制，因此就有人发明了虚拟机。



## 虚拟机

<img src="https://cvp.oss-cn-shanghai.aliyuncs.com/picgo/202305102104566.png" alt="image-20230510210455404" style="zoom: 67%;" />

* 虚拟机Virtual Machine英文缩写叫VM，虚拟机是使用虚拟化的技术，把一台物理机器虚拟化为多台虚拟机器，每一个虚拟机器上都可以独立的运行一个操作系统，要把一台物理机器虚拟化为多台虚拟机器，就需要使用到虚拟机管理程序，英文叫Virtual Machine Monitor缩写VMM，这个缩写也非常常见，也有人把虚拟机管理程序称为Hypervisor。在中文上，也会把它翻译为虚拟机监控程序，所以虚拟机管理程序，虚拟机监控程序，VMM Hypervisor这些术语都是一个意思。
* 接下来会使用虚拟机管理程序这个术语，虚拟机管理程序分为两类。 第一类的虚拟机管理程序会直接运行在硬件之上，虚拟机管理程序会把一个物理机器虚拟化为多台虚拟机器。 会把一个总的硬件资源划分为多个部分，分别给各个虚拟机来使用，每一台虚拟机器上面可以安装各自的操作系统，比如第一台虚拟机上安装Windows，第二台上面安装Linux，第三台上面又安装Windows，在每一个操作系统之上又可以运行各自的用户进程。 
* 简单说一下如何把一个机器上的硬件资源分配给各个虚拟机器，比如一个单核的CPU可以模拟多台虚拟机器，只需要把这个CPU的时间片进行划分，每个虚拟机器分配若干个时间片，这样在上层的这个操作系统看来似乎给自己分配的就是一个独立的CPU，但事实上只是把物理CPU的某一些时间片分配给他了，磁盘和内存的分配更不用说了，只需要把磁盘空间划分出来分配给各个虚拟机器，内存空间划分出来分配给各个虚拟机器，这样的话，每个虚拟机器都可以拥有各自独立的硬件资源。 
* 就有点类似于传统的计算机当中操作系统把硬件资源进行了划分。像CPU就是按时间划分为时间片，像内存磁盘这些就是划分为了不同的空间分配给各个进程，这样每个进程也可以拥有自己独立的资源，所以第一类虚拟机管理程序就有点类似于传统的操作系统一样，他会负责直接管理这些硬件资源，并且分配这些硬件资源，这只是一层更深的套娃而已。
* 值得一提的是，只有虚拟机管理程序是运行在内核态的，只有它可以使用特权最高的那些指令。而上层的操作系统和应用程序，他们实际上是运行在用户态的，这会导致一个问题，上层的操作系统，不知道自己运行在用户态，他以为自己运行在内核态，所以上层的操作系统依然会使用一些特权指令。但是刚才我们说只有虚拟机管理程序运行在内核态，所以上层的这个操作系统不能让它使用特权指令。 那这种情况怎么办呢？当上层的操作系统想要使用特权指令的时候，他的行为动作会被虚拟机管理程序给截获。然后这个虚拟机管理程序会负责把上层的操作系统想要执行的特权指令进行一些等价的转换。 反正就是要给上层模拟出好像这个指令执行成功了那种感觉，所以我们说上层的操作系统是运行在虚拟内核空间的。 它并不是真正的内核空间，实际上是用户空间，只不过他自己以为自己运行在内核空间而已。 这是第一类虚拟机管理程序，直接运行在硬件之上，直接会管理硬件,分配硬件资源。 
* 接下来再看第二类的虚拟机管理程序，这一类的虚拟机管理程序，不是直接运行在硬件上的。 而是运行在一个宿主操作系统上Host OS，比如在我的Mac电脑上，我安装了MacOS这个操作系统，那可以在电脑上安装第二类的虚拟机管理程序。 <img src="https://cvp.oss-cn-shanghai.aliyuncs.com/picgo/202305102123443.png" alt="image-20230510212336188" style="zoom: 67%;" />
* 比如很多同学可能听过Virtual Box或者VMware这是国内的学生比较常用的两款虚拟机管理程序。我的电脑上是安装了VirtualBox，安装了这个软件之后就可以去下载另一个操作系统的镜像文件。比如在VirtualBox上，安装一个Linux的操作系统并且可以指定要给上层安装的这个操作系统分配多大的内存，也可以给它指定要给它分配多大的磁盘空间，接下来就可以点启动，然后在Mac电脑上套娃启动一个Linux的操作系统，所以我的电脑本身是MacOS的操作系统，这就是宿主操作系统。 在我的操作系统之上，我安装了某一个第二类的虚拟机管理程序VirtualBox，在这个虚拟机管理程序之上就可以安装一个客户操作系统，比如我安装的就是一个Linux，如果我愿意的话，也可以安装一个Windows的操作系统，如果再安装一个Windows的客户操作系统的话可以在我的电脑上同时启动两个客户操作系统，当然也可以只启动一个，只要硬件资源足够，就可以在宿主操作系统之上安装并且同时启动多个客户操作系统。显然在我的操作系统之上，除了客户操作系统之外，还会同时运行着很多我自己安装的一些进程，比如现在正在给大家录课，那么我的电脑上还在运行PPT相关的进程，同时也可以启动我的客户操作系统，让客户操作系统也正常的工作，而我的客户操作系统启动了之后，就跟正常的操作系统一样，我也可以在上面安装软件，也可以让这些软件正常的运行。 所以有的时候我录课，如果想要给大家演示Windows操作系统的一些情况，那我就会启动一个Windows操作系统的虚拟机器。然后在上面安装一些Windows的应用程序，给大家做这样的演示。 所以第二类的虚拟机管理程序，它并不是直接运行在硬件之上，而是运行在宿主操作系统上面。这个虚拟机管理程序想要给各个虚拟机器分配硬件资源，那么它只能请求操作系统给它分配，然后再由这个虚拟机管理程序进行再分配，硬件资源的管理者依然是宿主操作系统。 这是两类虚拟机管理程序，第一类虚拟机管理程序和第二类虚拟机管理程序思想各不相同，由于他们的实现方式不同，因此就造成了一些特性上的差异这给大家做了一个总结



## 两类虚拟机管理程序(VMM)的对比

<img src="https://cvp.oss-cn-shanghai.aliyuncs.com/picgo/202305102134770.png" alt="image-20230510213442626" style="zoom:80%;" />

* 首先对物理资源的控制权，第一类的虚拟机管理程序是直接运行在硬件之上的，可以直接控制和分配这些物理硬件资源，而第二类的虚拟机管理程序是运行在宿主操作系统之上的。依赖于宿主操作系统为其分配物理资源，它要使用硬件资源，只能向宿主操作系统申请并且被分配，因此，两类虚拟机管理程序在给上层的客户操作系统分配资源的时候，也会出现一些差异。比如第一类虚拟机管理程序，在安装客户操作系统的时候，它会直接在原本的硬盘上给它划分一些存储空间，直接分配给它。比如说我把0-1024号块全部分配给第一台虚拟机VM1，然后从1025-2048号块全部给分配到第二台虚拟机VM2，可以直接把一些未经抽象的物理资源分配给上层的虚拟机器，这就有点类似于之前说的外核的分配方式
* 相比之下，第二类的虚拟机器向宿主操作系统申请物理资源的时候，宿主操作系统给它分配的资源是经过抽象的。 比如第二类虚拟机管理程序，想要给第一台虚拟机分配10GB的磁盘存储空间，那么虚拟机管理程序会向操作系统申请创建一个大小为10 GB的大文件。 这个大文件具体存放在磁盘当中的哪些位置，是由宿主操作系统来决定的。虚拟机管理程序在获得了10 GB的大文件之后，它又会把这10 GB的空间分配给第一台虚拟机器，让第一台虚拟机器以为自己好像拥有了10 GB的磁盘存储空间一样。 但事实上，这只是一个虚拟磁盘,这10 GB的空间在磁盘当中未必是连续的,背后对应的是宿主操作系统文件系统当中的一个大文件而已。 这是对于外存的分配，对于内存的分配也一样，第二类的虚拟机管理程序向操作系统请求给它分配一片内存空间，宿主操作系统给它分配了4 GB的内存空间。 但这4 GB事实上是虚拟内存，各个页面也许是离散存储的，虚拟机管理程序获得了4 GB的虚拟内存之后又可以把这4 GB的虚拟内存拆分，分给不同的虚拟机器，比如第一台虚拟机器分2GB，第二台虚拟机器又分2GB，他就是这么干的，所以就是多增加了一层套娃。 它本身得到的也是一个虚拟的硬件资源，然后他又把这个虚拟的硬件资源再虚拟再分配给各个虚拟机器。 显然，这会导致第一类虚拟机管理程序性能更好，因为每进行一次硬件的虚拟化，就意味着上层的用户操作系统在使用这些硬件资源的时候，它的这个地址需要先映射为这个虚拟机管理程序获得的虚拟地址空间。 然后宿主操作系统又需要把这个4GB的虚拟地址空间再给映射到实际的物理地址空间。 所以经过了多层的虚拟，就意味着在使用这些资源的时候，又需要经过多层的映射才可以对应到最终的物理地址上。这就会导致第二类的虚拟机管理程序，它的性能更差，总是需要通过宿主操作系统作为中介。另一个方面，在一台机器的硬件资源确定固定不变的情况下，第一类的虚拟机管理程序往往可以支持更多台的虚拟机。 因为第一类的虚拟机管理程序拥有所有的硬件资源，而第二类的虚拟机管理程序，他自己的资源需要跟宿主操作系统申请，宿主操作系统本身也需要一些硬件资源，同时它上面的这些进程也需要使用一些硬件资源，所以在硬件资源相同的情况下，显然第一类的虚拟机管理程序可以支持更多台的虚拟机。 这是可以支持的虚拟机数量
* 接下来虚拟机的可迁移性，第一类的虚拟机管理程序要迁移虚拟机，比如要把这台虚拟机器迁移到另一个虚拟机管理程序之上，这个迁移的动作是比较麻烦的。而第二类的虚拟机管理程序要迁移一台虚拟机就非常方便，比如我这个虚拟机管理程序上要迁移Linux操作系统，要把我的这个操作系统给你用，那么我只需要把这个操作系统导出为ISO就是镜像文件，然后直接把我这个镜像文件拷过去，在你自己的VirtualBox上面一加载—安装，就可以使用到跟我这边完全一样的操作系统了，包括我在我的这个客户操作系统上安装的一些程序或者数据什么的都可以一起打包给你，然后你可以很方便的迁移到你自己的virtual box上。由于它的可迁移性，所以第二类的虚拟机管理程序，它的商业化应用，目前来看是更广泛一些的，使用起来会很灵活
* 最后运行模式方面，第一类的虚拟机管理程序，它运行在最高的特权级别，可以使用最高特权的指令。以前介绍指令的时候，只是把指令分为了非特权指令和特权指令，这样的两个特权级别，但是在近几年的CPU当中，指令的特权级可能会被进行更多层次的划分。



## 支持虚拟化的CPU通常分更多指令等级

<img src="https://cvp.oss-cn-shanghai.aliyuncs.com/picgo/202305102158330.png" alt="image-20230510215805213" style="zoom: 50%;" />

* 比如划为零级，一级，二级，三级越往上特权级越低，越往下特权级别就越高。 所以第一类的虚拟机管理程序运行在0环指的就是它运行在最高的特权级别，它可以使用最高特权的一些指令，把指令划分为更多的特权级别是有好处的，比如像刚才我们说如果指令只分为非特权指令和特权指令。那么，任何一条特权指令的使用都需要虚拟机管理程序把它截获，并且判断这条特权指令的使用是否合法，如果合法的话还需要由它来模拟出特权指令执行的效果。但是如果对指令的特权集进行更精细化的一个分类。让第一类的虚拟程序运行在最高特权级Ring0，把这个最高的特权级别称为0环。然后让客户操作系统的内核运行在一环，次高特权级，接下来让用户进程运行在二环就是最低的特权级，进行了这样的划分就可以保证当上层的客户操作系统使用二环，一环的这些指令的时候，虚拟机管理程序不用管，直接让你执行就行了，除非你需要使用到少数的一些0环的指令，我才帮你检查这些0环的指令应不应该让你执行，会不会导致不安全等等，这就相当于把原本的特权指令进一步的进行了细分，把特权指令当中的一些敏感指令放在0环，然后把一些不敏感的指令放在1环。 这样的话，虚拟机管理程序不用检查每一条特权指令的执行，只需要检查某一些敏感指令的执行就可以了。
* 所以在第一类的虚拟机管理程序当中，只有虚拟机管理程序是运行在最高特权级的，上层的操作系统运行在次高优先级，再来看第二类的虚拟机管理程序，第二类虚拟机管理程序一部分运行在用户态， 一部分运行在内核态，在内核态的这个部分是以虚拟机驱动程序的方式加载到操作系统内核当中的，当上层的应用程序发出系统调用，比如说要write系统调用的时候，上层的操作系统可以直接去读写磁盘吗？显然不可以，所以用户进程的系统调用会被虚拟机管理程序截获，然后由虚拟机管理程序进行一些处理，代替它向底层的宿主操作系统发出write系统调用来请求底层宿主操作系统的服务。 
* 所以无论怎么看第二类的虚拟机管理程序，它的性能肯定都会更差一些，这个宿主操作系统总是要作为一个工具人，作为一个中介来被使用。 这就是第一章的最后一个考点，虚拟机，大家重点理解一下，这两页PPT就可以。

<img src="https://cvp.oss-cn-shanghai.aliyuncs.com/picgo/202305102208343.png" alt="image-20230510220854204" style="zoom: 67%;" />

<img src="https://cvp.oss-cn-shanghai.aliyuncs.com/picgo/202305102209195.png" alt="image-20230510220926058" style="zoom: 67%;" />

* 大概率是以选择题的方式来考察，而且不负责任的预测一下它肯定会考第一类虚拟机管理程序和第二类虚拟机管理程序的区别。 所以这儿才给大家做了这样的一个对比，我认为这是一个很有可能出现的命题角度。